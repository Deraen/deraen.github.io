<!DOCTYPE html>
<html itemscope="" itemtype="http://schema.org/BlogPosting"><head><meta charset="utf-8" /><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport" /><link href="/favicon.ico" rel="shortcut icon" /><link href="/atom.xml" rel="alternate" title="Atom feed" type="application/atom+xml" /><link href="/css/app.css" rel="stylesheet" type="text/css" /><link href="http://fonts.googleapis.com/css?family=Source%2BCode%2BPro%7CArvo%3A400%2C700%7CDroid%2BSerif%3A400%2C400italic%2C700" rel="stylesheet" type="text/css" /><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/languages/clojure.min.js" type="text/javascript"></script><script>hljs.initHighlightingOnLoad();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-36245688-2', 'auto');
ga('send', 'pageview');</script><meta content="Juho Teperi (juho.teperi@iki.fi)" itemprop="author" name="author" /><meta content="boot, cljs" itemprop="keywords" name="keywords" /><meta itemprop="description" name="description" /><meta content="en" itemprop="inLanguage" /><meta content="Sun Oct 04 03:00:00 EEST 2015" itemprop="dateCreated" /><meta content="Sun Oct 04 03:00:00 EEST 2015" itemprop="datePublished" /><title itemprop="name">Boot ClojureScript tooling updates and what's up next - Deraen's blog</title><link href="http://deraen.github.io/boot-cljs-tooling/" rel="canonical" /></head><body><nav class="header" role="navigation"><div class="container"><a class="site" href="/">Deraen's blog</a><ul><li><a href="/tags/">tags</a></li></ul></div></nav><div class="main"><div class="container"><article><h1 itemprop="name">Boot Clo­jure­Script tool­ing up­dates and what's up next</h1><div class="meta">04 October 2015</div><p>One of the fea­tures miss­ing from Boot Clo­jure­Script tool­ing in com­par­ison to <a href="https://github.com/bhauman/lein-figwheel">Figwheel</a> was heads-up dis­play (HUD). Thanks to <a href="https://twitter.com/martinklepsch">Martin Klepsch</a> this is now im­ple­men­ted in Boot-cljs and Boot-re­load. I've made a screen cast about the new fea­ture so check that to see how it works. Read on for some de­tails about the im­ple­ment­a­tion and to see what's up next for Boot Clo­jure­Script tool­ing.</p>
<h2><a href="#demonstration" name="demonstration"></a>Demon­stra­tion</h2>
<div class="video-wrapper">
  <iframe width="1280" height="720" src="https://www.youtube-nocookie.com/embed/QQ3J59AKZLU" frameborder="0" allowfullscreen="allowfullscreen"></iframe>
</div>
<h2><a href="#implementation" name="implementation"></a>Im­ple­ment­a­tion</h2>
<p>As Boot Clo­jure­Script tool­ing con­sists of mul­tiple sep­ar­ate tasks, im­ple­ment­a­tion of HUD re­quired changes to two tasks:</p>
<h3><a href="#boot-cljs" name="boot-cljs"></a>Boot-cljs</h3>
<p>Im­ple­ment­a­tion of HUD re­quires that in­form­a­tion about Clo­jure­Script warn­ings and ex­cep­tions is avail­able for send­ing to the cli­ent.</p>
<p>To catch the in­form­a­tion about Cljs warn­ings we'll set up cus­tom warn­ing-hand­ler. The hand­ler with both <em>(1)</em> print the warn­ing to con­sole and <em>(2)</em> store the warn­ings in an atom. The reason why we over­write de­fault warn­ing hand­ler which would also print the warn­ings to con­sole, is that we want to pro­cess file-path of the warn­ing be­fore print­ing. Be­cause Clo­jure­Script sees to source files at Boot tem­por­ary-dir­ect­or­ies the file paths in­clude the tem­por­ary dir­ect­ory path. To make the warn­ings cleaner we <em>(3)</em> re­trieve path for the ori­ginal file. Data about warn­ings is at­tached to <code>.cljs.edn</code> file metadata on the file­set.</p>
<pre><code class="clj">(fn [warning-type env extra]
  (when (warning-enabled? warning-type)
    (when-let [s (ana/error-message warning-type extra)]
                 ;; 3
      (let [path (util/find-original-path source-paths dirs ana/*cljs-file*)]
        ;; 1
        (butil/warn "WARNING: %s %s\n" s (when (:line env)
                                           (str "at line " (:line env) " " path)))
        ;; 2
        (swap! warnings conj {:message s
                              :file path
                              :line (:line env)
                              :type warning-type})))))
</code></pre>
<p>Hand­ling ex­cep­tions is a bit more trick­ier be­cause Clo­jure­Script com­piler is run­ning in­side a <a href="https://github.com/boot-clj/boot/wiki/Pods">pod</a>. Usu­ally the com­mu­nic­a­tion between pods hap­pens us­ing <code>pr-str</code> and <code>read-string</code>, very sim­il­arly to how Lein­in­gen com­mu­nic­ates between mul­tiple JVMs. But this does­n't hap­pen with ex­cep­tions, they are in­stead dir­ectly thrown. The prob­lem here is that for some reason when ex­cep­tions are thrown from one class­loader to an­other, they lose their <code>ex-info</code> metadata. For Clo­jure­Script ex­cep­tions the metadata con­tain all the in­ter­est­ing data: file-path, line num­ber and column num­ber.</p>
<p><a href="https://github.com/adzerk-oss/boot-cljs/blob/fd913b9c9a2bd9d51d28f855baadd225198950a2/src/adzerk/boot_cljs/util.clj#L47-L104">A workaround</a> I found for this is to manu­ally seri­al­ize and deseri­al­ize ex­cep­tions, in­clud­ing metadata, stack-trace and cause stack. This way it's pos­sible to throw ex­cep­tion with cor­rect metadata from Boot-cljs to Boot-re­load.</p>
<p>As with warn­ings, file paths in ex­cep­tions are changed to con­tain path to the ori­ginal file in­stead of to a file in tem­por­ary dir­ect­ory.</p>
<h3><a href="#boot-reload" name="boot-reload"></a>Boot-re­load</h3>
<p>Boot-re­load will either read warn­ings from <code>.cljs.edn</code> file metadata on the file­set or catch the ex­cep­tions thrown by Boot-cljs. Be­cause Boot tasks are im­ple­men­ted us­ing mid­dle­ware pat­tern it's simple as just call­ing <code>next-task</code> in­side <code>try-catch</code>. Boot-cljs will tag the ex­cep­tions so that we can dis­play only the <em>(1)</em> in­ter­est­ing ex­cep­tions on the browser. All ex­cep­tions are rethrown so that other tasks can ac­cess the ex­cep­tion data and to tell that the build failed.</p>
<pre><code class="clj">(try
  (next-task fileset)
  (catch Exception e
        ;; 1
    (if (= :boot-cljs (:from (ex-data e)))
      (send-visual! @pod {:exception (merge {:message (.getMessage e)}
                                            (ex-data e))}))
    (throw e)))
</code></pre>
<p>The heads-up dis­play user in­ter­face is im­ple­men­ted purely us­ing Google Clos­ure lib­rary. This keeps the build sim­pler as we don't need any ad­di­tional de­pend­en­cies. Even though we are not us­ing soph­ist­ic­ated frame­work like Re­act, the user in­ter­face im­ple­ment­a­tion is only about one hun­dred lines, in­clud­ing CSS defin­i­tions. UI is even im­ple­men­ted us­ing im­me­di­ate mode ren­der­ing: Whenever new <code>:visual</code> mes­sage is re­ceived from the server, old DOM con­tainer is re­moved and a new one is cre­ated.</p>
<h2><a href="#next-up" name="next-up"></a>Next up</h2>
<h3><a href="#boot-reload-fixes" name="boot-reload-fixes"></a>Boot-re­load fixes</h3>
<p>Cur­rent file-re­load­ing im­ple­ment­a­tion has some prob­lems when one has mul­tiple Clo­jure­Script builds in one pro­ject. Boot-re­load tries to load all changes JS files in browser but it's pos­sible that the files don't be­long to the open ap­plic­a­tion and cause prob­lems.</p>
<p>Google Clos­ure lib­rary defines a (private) de­pend­ency graph of namespaces and it should be pos­sible to use that to de­term­ine if changed file is re­quired by any loaded namespace, if it's not, we don't need to load the changed file.</p>
<p>The same de­pend­ency graph can be used to sort the changed files in de­pend­ency or­der. Cur­rently Boot-cljs is cal­cu­lat­ing this de­pend­ency or­der and passing it to Boot-re­load, this is ad­di­tional work as Clo­jure­Script com­piler has already done this and passed the data to Clos­ure.</p>
<p>Fig­wheel is already us­ing Clos­ure de­pend­ency data so I'll be look­ing on it's im­ple­ment­a­tion and copy­ing rel­ev­ant parts to Boot-re­load.</p>
<h3><a href="#boot-cljs-repl-fixes-and-improvements" name="boot-cljs-repl-fixes-and-improvements"></a>Boot-cljs-repl fixes and im­prove­ments</h3>
<p>I have now work­ing Clo­jure­Script REPL setup with <a href="https://github.com/tpope/vim-fireplace">Vim-fireplace</a> so I'll be fix­ing prob­lems as I en­counter them.</p>
<h3><a href="#boot-cljs-performance-fileset-performance-" name="boot-cljs-performance-fileset-performance-"></a>Boot-cljs per­form­ance (file­set per­form­ance)</h3>
<p>There have been mul­tiple re­ports of Boot-cljs be­ing slower than Lein­in­gen Cljs­build or Fig­wheel. On most cases the Clo­jure­Script com­piler works just as fast, but Boot file­sets cause some over­head which shows es­pe­cially with in­cre­mental re­com­piles. Per­form­ance pro­fil­ing should help to find the bot­tle­necks. Im­prov­ing this should help all Boot tasks.</p><aside><div class="meta"><span class="meta-label">Tags: </span><ul class="keywords"><li><a href="/tags/#boot">boot</a></li><li><a href="/tags/#cljs">cljs</a></li></ul></div></aside><aside class="comments"><div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES * * */
     var disqus_shortname = 'deraen';
     var disqus_identifier = 'boot-cljs-tooling/';

     /* * * DON'T EDIT BELOW THIS LINE * * */
     (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></aside></article></div></div><footer class="footer"><div class="container"><ul><li><a href="/atom.xml">RSS</a></li><li><a href="https://github.com/Deraen">github.com/Deraen</a></li><li><a href="https://twitter.com/JuhoTeperi">twitter.com/JuhoTeperi</a></li><li><a href="http://metosin.fi">metosin.fi</a></li></ul></div></footer></body></html>