<!DOCTYPE html>
<html itemscope="" itemtype="http://schema.org/BlogPosting"><head><meta charset="utf-8"><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"><meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport"><link href="/favicon.ico" rel="shortcut icon"><link href="/atom.xml" rel="alternate" title="Atom feed" type="application/atom+xml"><link href="/css/app.css" rel="stylesheet" type="text/css"><link href="http://fonts.googleapis.com/css?family=Source%2BCode%2BPro%7CArvo%3A400%2C700%7CDroid%2BSerif%3A400%2C400italic%2C700" rel="stylesheet" type="text/css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/languages/clojure.min.js" type="text/javascript"></script><script>hljs.initHighlightingOnLoad();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-36245688-2', 'auto');
ga('send', 'pageview');</script><meta content="Juho Teperi (juho.teperi@iki.fi)" itemprop="author" name="author"><meta content="boot, cljs" itemprop="keywords" name="keywords"><meta itemprop="description" name="description"><meta content="en" itemprop="inLanguage"><meta content="Sun Oct 04 03:00:00 EEST 2015" itemprop="dateCreated"><meta content="Sun Oct 04 03:00:00 EEST 2015" itemprop="datePublished"><title itemprop="name">Boot ClojureScript tooling updates and what's up next - Deraen's blog</title><link href="http://deraen.github.io/boot-cljs-tooling/" rel="canonical"></head><body><nav class="header" role="navigation"><div class="container"><a class="site" href="/">Deraen's blog</a><ul><li><a href="/tags/">tags</a></li></ul></div></nav><div class="main"><div class="container"><article><h1 itemprop="name">Boot ClojureScript tooling updates and what's up next</h1><div class="meta">04 October 2015</div><p>One of the features missing from Boot ClojureScript tooling in comparison to <a href="https://github.com/bhauman/lein-figwheel">Figwheel</a> was heads-up display (HUD). Thanks to <a href="https://twitter.com/martinklepsch">Martin Klepsch</a> this is now implemented in Boot-cljs and Boot-reload. I've made a screen cast about the new feature so check that to see how it works. Read on for some details about the implementation and to see what's up next for Boot ClojureScript tooling.</p>
<h2><a href="#demonstration" name="demonstration"></a>Demonstration</h2>
<div class="video-wrapper">
  <iframe width="1280" height="720" src="https://www.youtube-nocookie.com/embed/QQ3J59AKZLU" frameborder="0" allowfullscreen></iframe>
</div>
<h2><a href="#implementation" name="implementation"></a>Implementation</h2>
<p>As Boot ClojureScript tooling consists of multiple separate tasks, implementation of HUD required changes to two tasks:</p>
<h3><a href="#boot-cljs" name="boot-cljs"></a>Boot-cljs</h3>
<p>Implementation of HUD requires that information about ClojureScript warnings and exceptions is available for sending to the client.</p>
<p>To catch the information about Cljs warnings we'll set up custom warning-handler. The handler with both <em>(1)</em> print the warning to console and <em>(2)</em> store the warnings in an atom. The reason why we overwrite default warning handler which would also print the warnings to console, is that we want to process file-path of the warning before printing. Because ClojureScript sees to source files at Boot temporary-directories the file paths include the temporary directory path. To make the warnings cleaner we <em>(3)</em> retrieve path for the original file. Data about warnings is attached to <code>.cljs.edn</code> file metadata on the fileset.</p>
<pre><code class="clj">(fn [warning-type env extra]
  (when (warning-enabled? warning-type)
    (when-let [s (ana/error-message warning-type extra)]
                 ;; 3
      (let [path (util/find-original-path source-paths dirs ana/*cljs-file*)]
        ;; 1
        (butil/warn &quot;WARNING: %s %s\n&quot; s (when (:line env)
                                           (str &quot;at line &quot; (:line env) &quot; &quot; path)))
        ;; 2
        (swap! warnings conj {:message s
                              :file path
                              :line (:line env)
                              :type warning-type})))))
</code></pre>
<p>Handling exceptions is a bit more trickier because ClojureScript compiler is running inside a <a href="https://github.com/boot-clj/boot/wiki/Pods">pod</a>. Usually the communication between pods happens using <code>pr-str</code> and <code>read-string</code>, very similarly to how Leiningen communicates between multiple JVMs. But this doesn't happen with exceptions, they are instead directly thrown. The problem here is that for some reason when exceptions are thrown from one classloader to another, they lose their <code>ex-info</code> metadata. For ClojureScript exceptions the metadata contain all the interesting data: file-path, line number and column number.</p>
<p><a href="https://github.com/adzerk-oss/boot-cljs/blob/fd913b9c9a2bd9d51d28f855baadd225198950a2/src/adzerk/boot_cljs/util.clj#L47-L104">A workaround</a> I found for this is to manually serialize and deserialize exceptions, including metadata, stack-trace and cause stack. This way it's possible to throw exception with correct metadata from Boot-cljs to Boot-reload.</p>
<p>As with warnings, file paths in exceptions are changed to contain path to the original file instead of to a file in temporary directory.</p>
<h3><a href="#boot-reload" name="boot-reload"></a>Boot-reload</h3>
<p>Boot-reload will either read warnings from <code>.cljs.edn</code> file metadata on the fileset or catch the exceptions thrown by Boot-cljs. Because Boot tasks are implemented using middleware pattern it's simple as just calling <code>next-task</code> inside <code>try-catch</code>. Boot-cljs will tag the exceptions so that we can display only the <em>(1)</em> interesting exceptions on the browser. All exceptions are rethrown so that other tasks can access the exception data and to tell that the build failed.</p>
<pre><code class="clj">(try
  (next-task fileset)
  (catch Exception e
        ;; 1
    (if (= :boot-cljs (:from (ex-data e)))
      (send-visual! @pod {:exception (merge {:message (.getMessage e)}
                                            (ex-data e))}))
    (throw e)))
</code></pre>
<p>The heads-up display user interface is implemented purely using Google Closure library. This keeps the build simpler as we don't need any additional dependencies. Even though we are not using sophisticated framework like React, the user interface implementation is only about one hundred lines, including CSS definitions. UI is even implemented using immediate mode rendering: Whenever new <code>:visual</code> message is received from the server, old DOM container is removed and a new one is created.</p>
<h2><a href="#next-up" name="next-up"></a>Next up</h2>
<h3><a href="#boot-reload-fixes" name="boot-reload-fixes"></a>Boot-reload fixes</h3>
<p>Current file-reloading implementation has some problems when one has multiple ClojureScript builds in one project. Boot-reload tries to load all changes JS files in browser but it's possible that the files don't belong to the open application and cause problems.</p>
<p>Google Closure library defines a (private) dependency graph of namespaces and it should be possible to use that to determine if changed file is required by any loaded namespace, if it's not, we don't need to load the changed file.</p>
<p>The same dependency graph can be used to sort the changed files in dependency order. Currently Boot-cljs is calculating this dependency order and passing it to Boot-reload, this is additional work as ClojureScript compiler has already done this and passed the data to Closure.</p>
<p>Figwheel is already using Closure dependency data so I'll be looking on it's implementation and copying relevant parts to Boot-reload.</p>
<h3><a href="#boot-cljs-repl-fixes-and-improvements" name="boot-cljs-repl-fixes-and-improvements"></a>Boot-cljs-repl fixes and improvements</h3>
<p>I have now working ClojureScript REPL setup with <a href="https://github.com/tpope/vim-fireplace">Vim-fireplace</a> so I'll be fixing problems as I encounter them.</p>
<h3><a href="#boot-cljs-performance-fileset-performance-" name="boot-cljs-performance-fileset-performance-"></a>Boot-cljs performance (fileset performance)</h3>
<p>There have been multiple reports of Boot-cljs being slower than Leiningen Cljsbuild or Figwheel. On most cases the ClojureScript compiler works just as fast, but Boot filesets cause some overhead which shows especially with incremental recompiles. Performance profiling should help to find the bottlenecks. Improving this should help all Boot tasks.</p><aside><div class="meta"><span class="meta-label">Tags: </span><ul class="keywords"><li><a href="/tags/#boot">boot</a></li><li><a href="/tags/#cljs">cljs</a></li></ul></div></aside><aside class="comments"><div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES * * */
       var disqus_shortname = 'deraen';
       var disqus_identifier = '/boot-cljs-tooling/';

       /* * * DON'T EDIT BELOW THIS LINE * * */
       (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
       })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></noscript></div></aside></article></div></div><footer class="footer"><div class="container"><ul><li><a href="/atom.xml">RSS</a></li><li><a href="https://github.com/Deraen">github.com/Deraen</a></li><li><a href="https://twitter.com/JuhoTeperi">twitter.com/JuhoTeperi</a></li><li><a href="http://metosin.fi">metosin.fi</a></li></ul></div></footer></body></html>